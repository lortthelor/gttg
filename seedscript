-- AutoPlant.lua
-- LocalScript in StarterPlayerScripts

local Players    = game:GetService("Players")
local RepStorage = game:GetService("ReplicatedStorage")
local player     = Players.LocalPlayer

-- RemoteEvent per piantare
local PlantEvent = RepStorage
    :WaitForChild("Events")
    :WaitForChild("Farming")
    :WaitForChild("Plant")

-- La cartella con la tua griglia 16×7
local farmFolder = workspace
    :WaitForChild("MinigameModels")
    :WaitForChild("Farming")
    :WaitForChild("Player")
    :WaitForChild("cubozzi")

-- ------------- 1) Legge i semi dalla GUI -------------
local function getSeedData()
    local out = {}
    local mainUi = player:WaitForChild("PlayerGui")
                       :WaitForChild("MainUi")
    local inv    = mainUi
        :WaitForChild("InventoryFrame")
        :WaitForChild("Item")
        :WaitForChild("Farm")

    for _, seedItem in ipairs(inv:GetChildren()) do
        local frame  = seedItem:FindFirstChild("Frame")
        local amtLbl = frame and frame:FindFirstChild("Amount")
        if amtLbl and amtLbl:IsA("TextLabel") then
            local n = tonumber( amtLbl.Text:match("%d+") ) or 0
            if n > 0 then
                local t    = seedItem.Name:gsub(" Seed","")          -- es. "Strawberry"
                local rare = frame:FindFirstChild("RARE") ~= nil     -- seme raro?
                table.insert(out, { seedType = t, qty = n, isRare = rare })
            end
        end
    end

    -- ordina: prima i rari, poi alfabetico
    table.sort(out, function(a,b)
        if a.isRare ~= b.isRare then return a.isRare end
        return a.seedType < b.seedType
    end)

    return out
end

-- ------------- 2) Ciclo di planting -------------
spawn(function()
    while true do
        task.wait(0.6)  -- ogni 0.6 secondi

        -- prendi le quantità aggiornate dei semi
        local seeds = getSeedData()
        if #seeds == 0 then 
            -- niente semi, interrompi qui
            return 
        end

        -- percorri la griglia Z=0→6, X=0→15
        for z = 0, 6 do
            for x = 0, 15 do
                local slotName = x.."_"..z
                local slot     = farmFolder:FindFirstChild(slotName)
                -- se esiste e non ha ancora pianta
                if slot and slot:GetAttribute("HasPlant") == false then
                    -- trova il primo seme disponibile
                    for _, s in ipairs(seeds) do
                        if s.qty > 0 then
                            -- pianta
                            PlantEvent:FireServer(slot, s.seedType)
                            s.qty = s.qty - 1
                            task.wait(0.02)  -- piccolo buffer
                            break
                        end
                    end
                end
            end
        end
    end
end)
